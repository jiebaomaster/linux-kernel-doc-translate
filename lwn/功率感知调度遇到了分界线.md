# 功率感知调度遇到了分界线

> 原文链接 [Power-aware scheduling meets a line in the sand](https://lwn.net/Articles/552885/)，by Jonathan Corbet，2013-6-5

随着移动处理器和嵌入式处理器变得越来越复杂，使用的也越来越多，人们对提高调度程序的电源效率越来越感兴趣。尽管社区中有许多与[电源相关的调度程序补丁](开发更加节能的调度器.md)，但似乎没有一个能够合并到主线中。调度程序的更改通常都很难进行，而电源相关的补丁由各个行业背景的开发者发布，调度程序的维护者通常并不关注这些行业的需求，而且这些补丁中还存在一些竞争性关系，这又使得情况变得更加复杂了。现在看来，情况的复杂性又增加了，以至于任何能效补丁都更加难以被接受。

当前的讨论始于 5 月底，当时 Morten Rasmussen 发布了一些[性能测试](https://lwn.net/Articles/552323/)结果，比较了一些现有的补丁集在少部分工作负载类型上的表现差异。Morten 此举显然是为了推动讨论的进行，以便决定将哪些补丁并入主线。然而，讨论最终得到了一个显然不可能让任何相关开发人员满意的结果：调度器维护者 Ingo Molnar 对于讨论的[回复](https://lwn.net/Articles/552889/)措辞强烈，他说这是“[line in the sand](https://en.wikipedia.org/wiki/Line_in_the_sand)”，他在回复中指出了应该如何设计功率感知调度，并表示现有的这些补丁集不做大更改的话，都不可能合并入主线。

Ingo 的抱怨并不是真正针对那些现有的补丁，而是针对当前内核的 CPU 电源管理的整体实现。当前，CPU 电源管理职责分为三个独立的部分：

- 显然，调度程序会影响系统的电源使用。多年来，调度程序添加了一些提高系统电源效率的补丁，比如[可延迟计时器（deferrable timers）](https://lwn.net/Articles/228143/)和[抑制空闲 CPU 的定时器触发（suppressing the timer tick when idle）](https://lwn.net/Articles/223185/)。
- CPU 频率（“cpufreq”）子系统测量每个处理器的空闲时间来调节处理器的时钟频率。大部分时间处于空闲状态的处理器，可以降低频率，从而降低功耗；总是忙碌的处理器在符合条件时应该以更高的频率运行。大多数系统使用 [on-demand cpufreq 调控器](https://lwn.net/Articles/384132/)。[大小核切换器（big.LITTLE switcher）](https://lwn.net/Articles/539840/)在这一层上运作，它将“大”和“小”处理器之间的差异描述为不同范围的可用频率。
- [cpuidle 子系统](https://lwn.net/Articles/384146/)负责管理处理器睡眠状态。人们可能会认为睡眠只是把频率切换到 0 Hz，但实际上睡眠比这复杂得多。现代处理器有很多种睡眠状态，每种状态在耗电量、对 CPU 缓存造成的损害以及进入和离开该状态所需的时间上都有所不同。

Ingo 的观点是，电源管理责任的分裂，导致了无法实施明确的策略：
> 如今，省电格局变得零散且令人沮丧：我们只是随机地根据一些空闲策略和 cpufreq 策略修改调度程序任务打包机制，根本不知道这些策略能否良好地组合在一起。即使某种修改的测试成绩更好，这也是一个完全随机的，基本上不可维护的属性：因为“调度策略”和“空闲策略”之间没有明确的划分。

他希望看到一种新设计：将电源管理相关的所有 CPU 操作都移到调度程序中。调度器中有关于当前工作负载和 CPU 拓扑的所有信息，因此应该在此做决策。他声称，任何与电源相关的补丁都必须使系统朝这个方向发展：
> 对于任何调度程序省电补丁来说，这都是“底线”，是“必须具备”的设计属性，而我将拒绝接受不能解决根本设计问题的补丁。

不用说，当前的补丁集都没有对调度程序、cpuidle 和 cpufreq 子系统的基础重新设计。因此，所有这些补丁都不是建议修改而是拒绝了-这可能不是这些补丁的开发人员所希望的。

Morten 在答复中讨论了集成的电源感知调度程序必须处理的问题。首先要面对一些基本挑战，例如定义节电策略以实现节电运行，以及定义一种机制来选择和实施特定策略。热量管理通常需要降低 CPU 频率或完全关闭处理器电源，因此需要在调度程序中描述系统的电源拓扑结构；该拓扑可能与现有调度域数据结构表示的缓存层次结构不匹配。总之，Morten 说：
> 这不是一个完整的列表。我的观点是，将所有策略移至调度程序将大大增加调度程序的复杂度。在我印象里，大家普遍认为调度程序已经太复杂了。如果我错了纠正我。

Morten 认为，现有补丁集是问题增量解决方案的一部分，是朝着总体目标迈出的一步。在撰写本文时，Ingo 是否会以相同的方式看待现有补丁集尚不清楚。他的话说得很坚定，但 lines in the sand 也相对容易移动。不过，如果他坚持自己的立场，电源感知调度的添加可能会无限期推迟。

对于子系统维护者而言，坚持对现有代码进行改进是合并新功能的前提是闻所未闻的。在过去的内核峰会上，这样的要求被认为是不公平的，但有时它们仍然存在。在我们这个例子中，Ingo 要求重新设计最复杂的内核核心子系统之一，然后才能添加更多功耗感知功能。对于那些已经在努力查看和合并代码的开发人员而言，这是一个很大的标准提高。可以想象，只有调度程序维护人员投入大量自己的时间到此之中，才能完成如此大规模的重新设计。

我们当中那些愤世嫉俗的人肯定会认为 Ingo 的立场是简单地让功率感知调度工作一去不复返。这显然是一种不正确的解释。更直接的解释是，调度程序维护者希望随着时间的推移代码变得更好，更可维护。现在要做的是找到一条通往更优调度器的路径，以便能在短期内改善电源管理。另一种选择是将节能调度代码合并到操作系统发行商的代码库，这似乎是次优的结果。
